# Conversation Flow Refactor - Implementation Status

## Overview

This document tracks the progress of refactoring the conversation system to use a **linear, loop-based architecture** with **HeyGen video avatar integration**.

---

## âœ… COMPLETED

### Server-Side Changes

#### 1. New Sessions Route (`server/src/routes/sessions.ts`)
Created comprehensive session management with three new endpoints:

- **`POST /api/sessions/initialize`**
  - Creates session with status 'initializing'
  - Generates moderator context and initial opening message using Claude
  - Stores moderator context in database
  - Returns `sessionId`, `moderatorId`, and `moderatorInitialMessage`

- **`POST /api/sessions/:id/generate-agents`**
  - Generates N agent personalities in parallel using Claude
  - Maps agent demographics to HeyGen avatar IDs
  - Creates agents in database with `heygenAvatarId` and `heygenConfig` fields
  - Uses `Promise.allSettled` for resilient parallel generation
  - Returns full agent data including HeyGen avatar IDs

- **`POST /api/sessions/:id/complete`**
  - Marks session as complete
  - Prepares for memory extraction (placeholder for now)

#### 2. Modified Turn Persistence (`server/src/routes/conversation.ts`)
Enhanced `POST /api/conversation/turn` endpoint:
- Analyzes user turn content for agent name mentions
- Returns `nextSpeakerId` if user explicitly mentioned an agent by name
- Enables intelligent routing when user addresses specific agents

#### 3. Database Schema Updates (`server/prisma/schema.prisma`)
Added new fields to Session model:
- `moderatorContext` (Json): Stores moderator context for conversation
- Updated `status` to include 'initializing' state

#### 4. Route Registration
Registered new sessions route in `server/src/index.ts`

---

### Client-Side Changes

#### 1. Refactored Zustand Store (`client/src/stores/conversationStore.ts`)
**Complete rewrite** to support linear loop architecture:

**New State:**
```typescript
speakers: Speaker[]          // Fixed ordered array [moderator, user, agent1, agent2, ...]
currentIndex: number         // Current position in speakers array
loopCount: number           // How many full loops completed (0-5)
maxLoops: number            // 5 loops â†’ then switch to games
isPlaying: boolean          // Audio/video currently playing
isLoading: boolean          // Show loading screen
preGeneratedTurn: {...}     // Cached next turn (text + optional audio)
moderatorId: string | null  // Moderator ID for session
```

**New Actions:**
- `initializeSpeakers()` - Builds fixed speaker array
- `advanceToNextSpeaker(serverSuggestedAgentId?)` - Linear progression with optional jump to specific agent
- `setIsLoading()`, `setIsPlaying()` - Loading and playback states
- `setPreGeneratedTurn()`, `clearPreGeneratedTurn()` - Pre-generation cache management

**Removed:**
- 7-rule speaker determination logic
- Phase progression (opening, exploration, deepening, synthesis, closing)
- `speakerIndices` with complex tracking
- `last5Turns`, `turnsSinceUserSpoke`, `userTurnsInLastFive`, `turnsSinceModeratorSpoke`
- `currentPhase`, `textCache`, `audioCache` (now in pre-generation)

#### 2. New Conversation Flow Hook (`client/src/hooks/useNewConversationFlow.ts`)
**Complete implementation** of new architecture with HeyGen integration:

**Key Functions:**

- **`initializeSession()`** - Phase 1 initialization:
  1. Call `POST /api/sessions/initialize`
  2. Call `POST /api/sessions/:id/generate-agents`
  3. Initialize speaker array
  4. Initialize HeyGen avatars for moderator + all agents
  5. Begin conversation with moderator opening

- **`initializeAllHeygenAvatars()`** - Initialize video avatars:
  - Creates HeyGen streaming avatar instances for each speaker
  - Uses HeyGen SDK to start avatar sessions
  - Stores instances in ref for lifecycle management

- **`executeAITurn()`** - Execute moderator or agent turn:
  1. Check for pre-generated turn (use if available)
  2. Otherwise generate text via Claude API
  3. Speak with HeyGen avatar (audio + video lip-sync)
  4. Save turn to database
  5. Trigger pre-generation for next turn

- **`preGenerateNextTurn()`** - Background optimization:
  - Generates text for next speaker while current speaker talks
  - Caches in store for instant use
  - Skips if next speaker is user

- **`handleUserTurn()`** - Handle user's speech:
  1. Save user transcript to database
  2. Check for `nextSpeakerId` suggestion from server
  3. Advance to next speaker (jump if suggested)
  4. Execute next AI turn

- **`skipCurrentSpeaker()`** - Skip functionality:
  - Stops HeyGen avatar
  - Advances to next speaker
  - Executes next turn

- **`cleanup()`** - Cleanup on unmount:
  - Stops all HeyGen avatar sessions
  - Clears avatar instances

**HeyGen Integration Details:**
- Uses `@heygen/streaming-avatar` SDK
- Audio generated by HeyGen TTS (not ElevenLabs)
- Avatar speaks with perfect lip-sync to generated audio
- Event-driven: `avatar_start_talking`, `avatar_stop_talking`, `stream_ready`

---

## ğŸš§ REMAINING WORK

### 1. Update Session.tsx Component
**File:** `client/src/pages/Session.tsx`

**Required Changes:**
- Replace `useConversationFlow` with `useNewConversationFlow`
- Remove WebSocket dependency (no longer needed for turn management)
- Call `initializeSession()` on mount instead of WebSocket session_start
- Update skip button to use `skipCurrentSpeaker()`
- Update microphone confirmation to use `handleUserTurn()`
- Remove old phase-based UI logic

**Example:**
```typescript
const { initializeSession, handleUserTurn, skipCurrentSpeaker, cleanup } = useNewConversationFlow();

useEffect(() => {
  if (participant && topic) {
    initializeSession(participant.id, participant.name, topic.title);
  }

  return () => cleanup();
}, [participant, topic]);
```

### 2. Games View Transition
**Currently:** Games choice screen appears after moderator closing remarks

**Required:** Trigger games after 5 complete loops

**Implementation:**
- The store already has `loopCount` and `maxLoops`
- `advanceToNextSpeaker()` already checks `loopCount >= maxLoops`
- When max loops reached, it sets `showGameChoice = true`
- **No additional code needed** - already implemented in store!

### 3. Skip Button Enhancement
**Current:** Skip button exists in Session.tsx

**Required:** Wire it to new flow

**Changes in Session.tsx:**
```typescript
const handleSkipTurn = () => {
  skipCurrentSpeaker();
};
```

### 4. Remove Old Code

**Files to Review/Clean:**
- `client/src/hooks/useSpeakerDetermination.ts` âŒ DELETE (7-rule system)
- `client/src/hooks/useConversationFlow.ts` âŒ DELETE or RENAME to `.old.ts`
- `client/src/hooks/useTextGeneration.ts` âš ï¸ REVIEW (may have useful utilities)
- `client/src/hooks/useAudioFetcher.ts` âš ï¸ REVIEW (may be used elsewhere)
- `server/src/services/orchestrator.ts` âš ï¸ REVIEW (may have useful functions)
- `server/src/websocket/handler.ts` âš ï¸ REVIEW (may still be needed for other features)

### 5. Database Migration
**Required:** Run Prisma migration to add `moderatorContext` field

```bash
cd server
npx prisma migrate dev --name add_moderator_context
```

### 6. Testing Checklist
- [ ] Session initialization loads moderator + agents
- [ ] Moderator speaks first with HeyGen video avatar
- [ ] User can speak and transcript is captured
- [ ] After user speaks, agent responds
- [ ] Loop cycles through: moderator â†’ user â†’ agents
- [ ] After 5 loops, game choice screen appears
- [ ] Skip button works (stops avatar, advances to next)
- [ ] Pre-generation works (instant response after user speaks)
- [ ] User mentioning agent by name routes to that agent
- [ ] HeyGen avatars show video for all speakers except user

---

## Architecture Summary

### Turn Flow (Linear Loop)

```
Loop 1:  Moderator â†’ User â†’ Agent1 â†’ Agent2 â†’ Agent3 â†’ Agent4 â†’ Agent5
Loop 2:  Moderator â†’ User â†’ Agent1 â†’ Agent2 â†’ Agent3 â†’ Agent4 â†’ Agent5
Loop 3:  Moderator â†’ User â†’ Agent1 â†’ Agent2 â†’ Agent3 â†’ Agent4 â†’ Agent5
Loop 4:  Moderator â†’ User â†’ Agent1 â†’ Agent2 â†’ Agent3 â†’ Agent4 â†’ Agent5
Loop 5:  Moderator â†’ User â†’ Agent1 â†’ Agent2 â†’ Agent3 â†’ Agent4 â†’ Agent5
         â†’ GAMES VIEW
```

**Exception:** If user mentions agent by name (e.g., "What do you think, Alice?"),
jump directly to Alice instead of following sequence.

### Optimizations

1. **Pre-generation:** While current speaker talks, generate next speaker's text in background
2. **HeyGen Sessions:** All avatars initialized upfront, ready to speak instantly
3. **Parallel Agent Generation:** All 5 agents created simultaneously
4. **Sequential Initialization:** Moderator â†’ Agents â†’ Start (clear loading states)

### Key Differences from Old Architecture

| Old System | New System |
|---|---|
| 7-rule speaker determination | Linear loop (index-based) |
| 5 phases (opening, exploration, etc.) | No phases - just loop count |
| Server-side turn management | Client-side turn management |
| Dynamic speaker selection | Fixed speaker order |
| ElevenLabs TTS + separate video | HeyGen TTS + video (integrated) |
| Complex caching system | Simple pre-generation cache |
| WebSocket-driven turns | HTTP API-driven turns |

---

## Next Steps

1. **Run database migration** to add `moderatorContext` field
2. **Update Session.tsx** to use `useNewConversationFlow`
3. **Test the full flow** end-to-end
4. **Remove old code** once new system is verified working
5. **Document any edge cases** discovered during testing

---

## Notes

- The new system is **simpler** and **more predictable**
- All complex logic moved to client-side (easier to debug)
- HeyGen integration is **fully implemented** with proper lifecycle management
- Pre-generation optimization should make turns feel **instant**
- Loop-based system is easier to reason about than rule-based system

